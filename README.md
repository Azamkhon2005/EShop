# Бузуруков Саидазамхон, БПИ 236, КПО КР 3
## Архитектура

Система построена на принципах микросервисной архитектуры:

*   **API Gateway (предполагается):** Отвечает за маршрутизацию запросов к соответствующим сервисам (в данном проекте не реализуется, но подразумевается как часть общей инфраструктуры).
*   **Orders Service:**
    *   Отвечает за создание заказов, просмотр списка заказов и статуса конкретного заказа.
    *   Использует паттерн **Transactional Outbox** для надежной отправки сообщений о необходимости оплаты заказа.
*   **Payments Service:**
    *   Отвечает за управление счетами пользователей (создание, пополнение, просмотр баланса).
    *   Обрабатывает команды на оплату заказов.
    *   Использует паттерны **Transactional Inbox** (для идемпотентной обработки входящих команд на оплату) и **Transactional Outbox** (для надежной отправки событий о результате оплаты).
*   **Message Queue (RabbitMQ):** Обеспечивает асинхронное взаимодействие между `Orders Service` и `Payments Service`.

## Функциональность

### Payments Service

*   **Создание счета пользователя:**
    *   `POST /api/accounts`
    *   Тело запроса: `{ "userId": "string" }`
    *   Ограничение: не более одного счета на пользователя.
*   **Пополнение счета:**
    *   `POST /api/accounts/{userId}/deposit`
    *   Тело запроса: `{ "amount": decimal }`
*   **Просмотр баланса счета:**
    *   `GET /api/accounts/{userId}/balance`

### Orders Service

*   **Создание заказа:**
    *   `POST /api/orders`
    *   Тело запроса: `{ "userId": "string", "items": [ { "productId": "string", "quantity": int, "price": decimal } ], "description": "string" }` (адаптируйте под вашу модель `CreateOrderRequestDto`)
    *   Асинхронно запускает процесс оплаты.
*   **Просмотр списка заказов пользователя:**
    *   `GET /api/orders/user/{userId}`
*   **Просмотр статуса заказа:**
    *   `GET /api/orders/{orderId}`

## Паттерны, реализованные в проекте

*   **Transactional Outbox:**
    *   В `Orders Service` при создании заказа.
    *   В `Payments Service` при отправке события о результате оплаты.
    *   Гарантирует, что сообщение будет отправлено в очередь *после* успешного коммита основной транзакции в БД.
*   **Transactional Inbox:**
    *   В `Payments Service` при обработке команды `ProcessPaymentCommand`.
    *   Гарантирует идемпотентность обработки входящих сообщений, предотвращая повторное выполнение операции (например, списания средств).
*   **Семантика Exactly-Once (для списания средств):**
    *   Достигается комбинацией Transactional Inbox и атомарности операции списания в рамках транзакции БД в `Payments Service`.

## Запуск проекта

### Требования

*   Docker
*   Docker Compose

### Инструкция по запуску

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/Azamkhon2005/EShop.git
    cd EShop
    ```

2.  **Запустите систему с помощью Docker Compose:**
    Находясь в корневой папке проекта (`EShop/`), выполните команду:
    ```bash
    docker-compose up --build
    ```
3._   **Доступ к сервисам:**
    *   **Payments Service API (Swagger):** `http://localhost:8081/index.html`
    
    *   **Orders Service API (Swagger):** `http://localhost:8082/index.html`
    
    *   **RabbitMQ Management UI:** `http://localhost:15672` (логин/пароль по умолчанию: `guest`/`guest`)
